sap.ui.define(["epta/ps/views/project/Project.controller","sap/ui/model/json/JSONModel","epta/ps/model/formatter","epta/ps/model/models","sap/ui/export/library","sap/ui/export/Spreadsheet"],function(e,t,a,i,r,n){"use strict";var s=r.EdmType;return e.extend("epta.ps.views.project.fragments.projectPlan.ProjectPlan",{onInit:function(){this.getEventBus().subscribe("_onProjectDetail","read",this._onDataLoaded,this);this.getEventBus().subscribe("_onProjectDetail","refresh",this._onDataLoaded,this);this.setModel(new t,"_dprog");this._controller=this.getView().getControllerName();this.getView().byId("prpGanttChartContainer").addCustomToolbarItem(new sap.m.Toolbar({content:[new sap.m.Button({icon:"sap-icon://download",press:this.exportExcel.bind(this)}),new sap.m.ToolbarSpacer({width:"10px"})]}))},onBeforeRendering:function(){this.getModel("layout").setProperty("/footer/save",true);this.getModel("layout").setProperty("/footer/cancel",true);this.getModel("layout").setProperty("/footer/filter",false);this.getModel("layout").setProperty("/footer/enabled",true)},exportSpreadsheet:function(e,t,a){return new sap.ui.export.Spreadsheet(e).build().catch(a?a.bind(this):null).then(t?t.bind(this):null)},exportExcel:function(e){var t=this.getView().byId("prpGanttChartTable").getBinding("rows");return t.getLength()<1?null:this.exportSpreadsheet({workbook:{columns:this.createColumnConfig(),hierarchyLevel:"Level"},dataSource:{type:"OData",useBatch:true,serviceUrl:t.getModel().sServiceUrl,headers:t.getHeaders?t.getHeaders():null,dataUrl:t.getDownloadUrl?t.getDownloadUrl():null,count:t.getLength(),sizeLimit:5},worker:true})},createColumnConfig:function(){var e=this.getModel("i18n").getResourceBundle();var t=[];t.push({label:e.getText("tblWBE"),property:"Wbselement",type:s.String});return t},onAfterRendering:function(){var e=this.getView().byId("prpGanttChartContainer").getGanttCharts()[0];setTimeout(function(){e.jumpToPosition(new Date)},1500)},_onDataLoaded:function(e,t,a){var i=this;var r="";if(t==="read"){r=this._activitiesToTree(a.NetworkActivity)}else if(t==="refresh"){r=this._activitiesToTree(a)}else{return}r.root.children.sort(function(e,t){var a=0;if(e.table.Wbselement>t.table.Wbselement){a=1}else if(e.table.Wbselement<t.table.Wbselement){a=-1}else if(e.table.Wbselement===t.table.Wbselement){if(e.activity>t.activity){a=1}else{a=-1}}return a});this.getView().byId("prpGanttChartTable").setData(r);var n=this.getView().byId("prpGanttChartContainer").getGanttCharts()[0];setTimeout(function(){n.jumpToPosition(new Date);i.getView().byId("prpGanttChartTable").rerender()},1500)},handleShapeDragEnd:function(e){var t=e.getParameter("sourceShapeData")[0].objectInfo.contextObj;var a=t.oModel.getProperty(t.sPath+"/id").indexOf("basic-")===0;if(a&&t.oModel.getProperty(t.sPath+"/table/BasicstartdateLimit").setHours("00","00","00","000")>new Date(e.getParameter("targetData").shapeTimestamp.startTime).setHours("00","00","00","000")){var i=t.oModel.getProperty(t.sPath+"/table/BasicstartdateLimit");var r=("00"+i.getDate()).substr(-2)+"/"+("00"+(i.getMonth()+1)).substr(-2)+"/"+i.getFullYear();this._onSuccessOrFailureDialog({},"{i18n>ui5Warning}","Warning","{i18n>prpWarningDate}"+" ("+r+")");return}var n=t.oModel.getProperty(t.sPath+"/order/0/endTime")-t.oModel.getProperty(t.sPath+"/order/0/startTime");var s=new Date(new Date(e.getParameter("targetData").shapeTimestamp.startTime).setHours("00","00","00","000"));this._updateTime(t.oModel,t.sPath,"/order/0/startTime",s);var o=new Date(s.getTime()+n);this._updateTime(t.oModel,t.sPath,"/order/0/endTime",o,a)},handleValueHelpDateBasicStart:function(e){this.handleValueHelpDateBasic(e,"Basicstartdate")},handleValueHelpDateBasicEnd:function(e){this.handleValueHelpDateBasic(e,"Basicenddate")},handleValueHelpDateBasic:function(e,t){var a=e.getSource().getParent().oBindingContexts;this._oInputBinding=a[Object.keys(a)[0]];var i=this["_oDialog"+t];if(!i){i=sap.ui.xmlfragment("epta.ps.views.project.fragments.projectPlan.fragments.Dialog"+t,this);this.getView().addDependent(i)}i.attachAfterClose(function(){e.getSource().getContent().getContent()[0].removeAllSelectedDates()});var r=this._oInputBinding.oModel.getProperty(this._oInputBinding.sPath+"/table/"+t);i.getContent()[0].addSelectedDate(new sap.ui.unified.DateRange({startDate:r}));var n=new Date("1970-01-01");var s=new Date("9999-12-31");if(t==="Basicstartdate"){n=this._oInputBinding.oModel.getProperty(this._oInputBinding.sPath+"/table/BasicstartdateLimit");s=this._oInputBinding.oModel.getProperty(this._oInputBinding.sPath+"/table/Basicenddate")}else if(t==="Basicenddate"){n=this._oInputBinding.oModel.getProperty(this._oInputBinding.sPath+"/table/Basicstartdate")}i.getContent()[0].setMinDate(n);i.getContent()[0].setMaxDate(s);i.getContent()[0].focusDate(r);i.open()},handleValueHelpDateAddStart:function(e){this.handleValueHelpDateAdd(e,"Addstartdate")},handleValueHelpDateAddEnd:function(e){this.handleValueHelpDateAdd(e,"Addfinishdate")},handleValueHelpDateAdd:function(e,t){var a=e.getSource().getParent().oBindingContexts;this._oInputBinding=a[Object.keys(a)[0]];var i=this["_oDialog"+t];if(!i){i=sap.ui.xmlfragment("epta.ps.views.project.fragments.projectPlan.fragments.Dialog"+t,this);this.getView().addDependent(i)}i.attachAfterClose(function(){e.getSource().getContent().getContent()[0].removeAllSelectedDates()});var r=this._oInputBinding.oModel.getProperty(this._oInputBinding.sPath+"/table/"+t);i.getContent()[0].addSelectedDate(new sap.ui.unified.DateRange({startDate:r}));var n=new Date("1970-01-01");var s=new Date("9999-12-31");if(t==="Addstartdate"){n=this._oInputBinding.oModel.getProperty(this._oInputBinding.sPath+"/table/BasicstartdateLimit");s=this._oInputBinding.oModel.getProperty(this._oInputBinding.sPath+"/table/Addfinishdate")}else if(t==="Addfinishdate"){n=this._oInputBinding.oModel.getProperty(this._oInputBinding.sPath+"/table/Addstartdate")}i.getContent()[0].setMinDate(n);i.getContent()[0].setMaxDate(s);i.getContent()[0].focusDate(r);i.open()},onDialogDateBasicStartSave:function(e){if(!this._oSelectedDate)return;var t=new Date(new Date(this._oSelectedDate).setHours("01","00","00","000"));this._updateTime(this._oInputBinding.oModel,this._oInputBinding.sPath,"/order/0/startTime",t,true)},onDialogDateBasicEndSave:function(e){if(!this._oSelectedDate)return;var t=new Date(new Date(this._oSelectedDate).setHours("01","00","00","000"));this._updateTime(this._oInputBinding.oModel,this._oInputBinding.sPath,"/order/0/endTime",t,true)},onDialogDateAddStartSave:function(e){if(!this._oSelectedDate)return;var t=new Date(new Date(this._oSelectedDate).setHours("01","00","00","000"));this._updateTime(this._oInputBinding.oModel,this._oInputBinding.sPath+"/children/0","/order/0/startTime",t,false)},onDialogDateAddFinishSave:function(e){if(!this._oSelectedDate)return;var t=new Date(new Date(this._oSelectedDate).setHours("01","00","00","000"));this._updateTime(this._oInputBinding.oModel,this._oInputBinding.sPath+"/children/0","/order/0/endTime",t,false)},onSelectDate:function(e){this._oSelectedDate=e.getSource().getSelectedDates()[0].getProperty("startDate")},onActivityDescModify:function(e){var t=e.getSource().getParent().oBindingContexts;this._oSelectedContext=t[Object.keys(t)[0]];if(!this._oNoteDialog){this._oNoteDialog=sap.ui.xmlfragment("epta.ps.views.project.fragments.projectPlan.fragments.DialogDescription",this);this.getView().addDependent(this._oNoteDialog)}this._oNoteDialog.getContent()[0].setValue(this._oSelectedContext.oModel.getProperty(this._oSelectedContext.sPath+"/table/Description"));this._oNoteDialog.open()},onActivityDescDialogSave:function(e){var t=this;var a=e.getSource().getContent()[0].getValue();this._oSelectedContext.oModel.setProperty(this._oSelectedContext.sPath+"/table/Description",a);this._handleChange(this._oSelectedContext.oModel.getProperty(this._oSelectedContext.sPath+"/table"),{Description:a})},handleValueHelpProgress:function(e){var t=e.getSource().getParent().oBindingContexts;this._oSelectedContext=t[Object.keys(t)[0]];this.getModel("_dprog").setProperty("/progress",parseInt(this._oSelectedContext.oModel.getProperty(this._oSelectedContext.sPath+"/table/Apoc"),10));if(!this._oDialog){this._oDialog=sap.ui.xmlfragment("epta.ps.views.project.fragments.projectPlan.fragments.DialogProgress",this);this.getView().addDependent(this._oDialog)}this._oDialog.open()},onDialogProgressSave:function(e){var t=this;var a=this.getModel("_dprog").getProperty("/progress").toString();this._oSelectedContext.oModel.setProperty(this._oSelectedContext.sPath+"/table/Apoc",a);this._handleChange(this._oSelectedContext.oModel.getProperty(this._oSelectedContext.sPath+"/table"),{Apoc:a})},handleChangeBasicDuration:function(e){var t=this;var a=e.getSource().getParent().getBindingContext();var i=a.oModel.getProperty(a.sPath+"/table");this._handleChange(a.oModel.getProperty(a.sPath+"/table"),{Basicduration:e.getParameter("value")});this.getView().setBusy(true);var r=a.oModel.getProperty(a.sPath+"/table/Basicstartdate").getFullYear()+"-"+("00"+(a.oModel.getProperty(a.sPath+"/table/Basicstartdate").getMonth()+1)).substr(-2)+"-"+("00"+a.oModel.getProperty(a.sPath+"/table/Basicstartdate").getDate()).substr(-2)+"T00:00:00";this.getService().getCalendarDates({urlParameters:{DateFrom:"datetime'"+a.oModel.getProperty(a.sPath+"/table/Basicstartdate").toISOString().substr(0,19)+"'",Days:"'"+e.getParameter("value")+"'"},success:function(e){t.getView().setBusy(false);t._updateTime(a.oModel,a.sPath,"/order/0/endTime",e.DateTo)},error:function(){t.getView().setBusy(false)}})},_updateTime:function(e,t,a,i,r){var n=this;var s=e.getProperty(t+a.substr(0,a.lastIndexOf("/")+1)+"type")+a.substr(a.lastIndexOf("/")+1).replace("Time","date");if(s==="Addenddate")s="Addfinishdate";var o=JSON.parse('{"'+s+'":null}');var d=t.substr(0,t.indexOf("/children/",15)>0?t.indexOf("/children/",15):t.length);e.setProperty(t+a,i);var l=d+"/table/"+s;e.setProperty(l,e.getProperty(t+a));o[s]=new Date(e.getProperty(t+a).getTime()-e.getProperty(t+a).getTimezoneOffset()*6e4);var g=["Description","Apoc","Basicduration","Basicstartdate","Basicenddate"];var c=false;if(s.substr(0,3)==="Add"){g=["Addstartdate","Addfinishdate"];c=true}this._handleChange(e.getProperty(d+"/table/"),o,g,c);if(r){this.getView().setBusy(true);var h=e.getProperty(t+"/table/Basicstartdate").getFullYear()+"-"+("00"+(e.getProperty(t+"/table/Basicstartdate").getMonth()+1)).substr(-2)+"-"+("00"+e.getProperty(t+"/table/Basicstartdate").getDate()).substr(-2)+"T00:00:00";var u=e.getProperty(t+"/table/Basicenddate").getFullYear()+"-"+("00"+(e.getProperty(t+"/table/Basicenddate").getMonth()+1)).substr(-2)+"-"+("00"+e.getProperty(t+"/table/Basicenddate").getDate()).substr(-2)+"T00:00:00";this.getService().getCalendarDates({urlParameters:{DateFrom:"datetime'"+h+"'",DateTo:"datetime'"+u+"'"},success:function(a){n.getView().setBusy(false);e.setProperty(t+"/table/Basicduration",a.Days);n._handleChange(e.getProperty(t+"/table"),{Basicduration:a.Days.toString()})},error:function(){n.getView().setBusy(false)}})}var p="";l=l.replace(s.indexOf("Add")===0?"finish":"end","start");p=("0"+e.getProperty(l).getDate()).substr(-2)+"/"+("0"+(e.getProperty(l).getMonth()+1)).substr(-2);l=l.replace("start",s.indexOf("Add")===0?"finish":"end");p+=" - "+("0"+e.getProperty(l).getDate()).substr(-2)+"/"+("0"+(e.getProperty(l).getMonth()+1)).substr(-2);setTimeout(function(){$("g[data-sap-gantt-row-id='"+e.getProperty(t+"/id")+"'] g title").html(p)},500)},_handleChange:function(e,t,a,i){if(!a){a=["Description","Apoc","Basicduration","Basicstartdate","Basicenddate"]}if(typeof i==="undefined"){i=false}a.forEach(function(a){if(!t[a]){t[a]=e[a];return}if(a.substr(-4)!=="date"){t[a]=t[a].toString()}});this._addChange(this._controller,"PrjUpdate"+(i?"_AddDates":""),"/NetworkActivitySet(Projectnetwork='"+e.Projectnetwork+"',"+"Networkactivity='"+e.Networkactivity+"',"+"Wbselement='"+e.Wbselement+"')",t,this.getService()._sGroupUpdateId)},_activitiesToTree:function(e){var t=i.createGanttBaseModel();var r=e[0].Forecastedenddate||(new Date).setHours("00","00","00","000");r=new Date(new Date(r).getTime()+new Date(r).getTimezoneOffset()*6e4);var n=(new Date).setHours("00","00","00","000");var s=[{handOverDate:r,level:"3",name:("00"+r.getDate()).substr(-2)+"/"+("00"+(r.getMonth()+1)).substr(-2)}];for(var o=0;o<e.length;o++){var d=e[o];var l=d.Basicstartdate;if(l){l=new Date(new Date(l).getTime()+new Date(l).getTimezoneOffset()*6e4)}var g=d.Basicenddate;if(g){g=new Date(new Date(g).getTime()+new Date(g).getTimezoneOffset()*6e4)}if(!d.Addstartdate){d.Addstartdate=d.Basicstartdate||new Date(new Date((new Date).getTime()-24*60*60*1e3).setHours(0,0,0,0))}var c=d.Addstartdate;if(c){c=new Date(new Date(c).getTime()+new Date(c).getTimezoneOffset()*6e4)}if(!d.Addfinishdate){d.Addfinishdate=d.Basicenddate||new Date(new Date((new Date).getTime()).setHours(0,0,0,0))}var h=d.Addfinishdate;if(h){h=new Date(new Date(h).getTime()+new Date(h).getTimezoneOffset()*6e4)}var u=d.Forecastedstartdate;if(u){u=new Date(new Date(u).getTime()+new Date(u).getTimezoneOffset()*6e4)}var p=d.Forecastedenddate;if(p){p=new Date(new Date(p).getTime()+new Date(p).getTimezoneOffset()*6e4)}var D=d.Actualstartdate;if(D){D=new Date(new Date(D).getTime()+new Date(D).getTimezoneOffset()*6e4)}var f=d.Actualenddate;if(f){f=new Date(new Date(f).getTime()+new Date(f).getTimezoneOffset()*6e4)}if(d.Networkactivity!==""){d.BasicstartdateLimit=e.filter(function(e){return e.Networkactivity==="0010"&&e.Wbselement===d.Wbselement})[0].Basicstartdate}d.dealyStatus="None";if(d.Wbselementhierarchylevel===3&&d.Forecastedenddate&&d.Basicenddate){d.dealyStatus=d.Basicenddate<d.Forecastedenddate?"None":"Error"}var m=d.Wbsdescription+(d.Description===""?"":" - "+d.Description);var v={id:"basic-"+d.Wbselement+d.Networkactivity,activity:d.Projectnetwork+" "+d.Networkactivity,level:"01",name:m,tooltip:m,table:d,children:[],order:[],handOver:s};var b="";if(d.Basicstartdate&&d.Basicenddate){b=("0"+l.getDate()).substr(-2)+"/"+("0"+(l.getMonth()+1)).substr(-2);b+=" - "+("0"+g.getDate()).substr(-2)+"/"+("0"+(g.getMonth()+1)).substr(-2);v.order.push({startTime:l,endTime:g,level:"0",name:b,type:"Basic",enableDnD:d.Networkactivity!=="0010",Projectnetwork:d.Projectnetwork,Networkactivity:d.Networkactivity,Wbselement:d.Wbselement})}if(d.Addstartdate&&d.Addfinishdate&&d.Basicstartdate&&d.Networkactivity==="0010"&&d.Wbselementhierarchylevel===3){b=("0"+c.getDate()).substr(-2)+"/"+("0"+(c.getMonth()+1)).substr(-2);b+=" - "+("0"+h.getDate()).substr(-2)+"/"+("0"+(h.getMonth()+1)).substr(-2);v.children.push({id:"add-"+d.Wbselement+d.Networkactivity,level:"02",name:m,tooltip:m,order:[{startTime:c,endTime:h,level:"4",name:b,type:"Add",enableDnD:true,Projectnetwork:d.Projectnetwork,Networkactivity:d.Networkactivity,Wbselement:d.Wbselement}],table:{},handOver:s})}if(d.Forecastedstartdate&&d.Forecastedenddate){b=("0"+u.getDate()).substr(-2)+"/"+("0"+(u.getMonth()+1)).substr(-2);b+=" - "+("0"+p.getDate()).substr(-2)+"/"+("0"+(p.getMonth()+1)).substr(-2);v.children.push({id:"fcs-"+d.Wbselement+d.Networkactivity,level:"02",name:m,tooltip:m,order:[{startTime:u,endTime:p,level:"1",name:b,type:"Forecasted",enableDnD:false}],table:{},handOver:s})}if(D&&f){b=("0"+D.getDate()).substr(-2)+"/"+("0"+(D.getMonth()+1)).substr(-2);b+=" - "+("0"+f.getDate()).substr(-2)+"/"+("0"+(f.getMonth()+1)).substr(-2);v.children.push({id:"act-"+d.Wbselement,level:"02",name:m,tooltip:m,order:[{startTime:D,endTime:f,level:"2",name:m,type:"Actual",enableDnD:false}],table:{},handOver:s})}t.root.children.push(v);if(d.ActivityPredecessor){t.root.relationships.push({fromDataId:d.Projectnetwork+" "+d.ActivityPredecessor,fromObjectPath:d.Projectnetwork+" "+d.ActivityPredecessor,fromShapeId:"order",guid:"rel_"+d.ActivityPredecessor+"_"+d.Networkactivity,relation_type:1,style:0,toDataId:d.Projectnetwork+" "+d.Networkactivity,toObjectPath:d.Projectnetwork+" "+d.Networkactivity,toShapeId:"order",tooltip:this.getResourceBundle().getText("relationship")})}if(u&&u<t.ganttStartTime){t.ganttStartTime=u}if(l&&l<t.ganttStartTime){t.ganttStartTime=l}if(D&&D<t.ganttStartTime){t.ganttStartTime=D}if(p&&p>t.ganttEndTime){t.ganttEndTime=p}if(g&&g>t.ganttEndTime){t.ganttEndTime=g}if(f&&f>t.ganttEndTime){t.ganttEndTime=f}}t.ganttStartTime=a.dateToString(new Date(t.ganttStartTime.getFullYear(),t.ganttStartTime.getMonth()+1,1));t.ganttEndTime=a.dateToString(new Date(t.ganttEndTime.getFullYear(),t.ganttEndTime.getMonth()+3,0));return t}})});