sap.ui.define(["epta/ps/ui5/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","epta/ps/model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessagePopover","sap/m/MessageItem","sap/m/MessageToast","sap/ui/core/ValueState","sap/m/Dialog","sap/m/DialogType","sap/m/Button","sap/m/ButtonType","sap/m/Text"],function(e,t,s,a,o,n,r,i,l,c,u,d,g,p,h){"use strict";var f="";return e.extend("epta.ps.views.project.Project",{formatter:a,metadata:{properties:{showTitle:{type:"boolean",defaultValue:false}}},_projectId:undefined,_changes:{},onInit:function(){var e=this;this.getRouter().getRoute("project").attachPatternMatched(this._onObjectMatched,this);this.getEventBus().subscribe("_onODataModel","error",this._onODataModel,this);this.setModel(new t({footer:{messages:0,cancel:false,save:false,filter:false,enabled:true}}),"layout");this.setModel(new t,"ChangeModel");this._oMsgModel=new t([]);this._oMessagePopover=new r({items:{path:"/",template:new i({type:"{type}",title:"{title}",description:"{description}",subtitle:"{subtitle}"})},beforeClose:function(t){e.getModel("layout").setProperty("/footer/messages",0)}});this._oMessagePopover.setModel(this._oMsgModel)},onBeforeRendering:function(){this.setModel(new t,"Hierarchy");this.setModel(new t,"NetworkActivity");this.setModel(new t,"ProjectHeader");this.setModel(new t,"WbselementData");this.setModel(new t,"PurReq");this.setModel(new t,"InstallationManager");this.setModel(new t,"Vendor");this.setModel(new t,"WorkCenter");this.setModel(new t,"SearchUom");this.setModel(new t,"SearchCurc");this.setModel(new t,"InstallationManagerFilter");this.getView().setBusy(true)},onNavBack:function(){this.getEventBus().publish("_onNavBack","clearModel",{});this.getRouter().navTo("search",true)},onNoteModify:function(e){if(!this._oNoteDialog){this._oNoteDialog=sap.ui.xmlfragment("epta.ps.views.project.fragments.fragments.DialogNote",this);this.getView().addDependent(this._oNoteDialog)}this._oNoteDialog.open()},onNoteDialogSave:function(e){this.getService().getModel().update("/ProjectHeaderSet('"+this.getModel("ProjectHeader").getProperty("/Wbselement")+"')",{Longtext:this.getModel("ProjectHeader").getProperty("/Longtext")},{groupId:this.getService()._sGroupUpdateNoteId});this.fireBatchSave(this.getService()._sGroupUpdateNoteId)},onIconTabItemSelect:function(e){var t=this.getView().byId("prjPanel");if(t.getExpanded()){t.setExpanded(false)}if(!e.getSource().getExpanded()){t.setExpanded(true)}},onConfirmDialog:function(e){var t=new sap.m.Dialog({title:"{i18n>ui5Confirm}",type:"Message",content:new sap.m.Text({text:"{i18n>ui5ConfirmText}"}),beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:"{i18n>ui5Submit}",press:function(){t.close()}}),endButton:new sap.m.Button({text:"{i18n>ui5Cancel}",press:function(){t.close()}}),afterClose:function(){t.destroy()}});t.open()},onBatchCancel:function(e){var t=this;var s=new sap.m.Dialog({title:"{i18n>ui5Confirm}",type:"Message",content:new sap.m.Text({text:"{i18n>ui5ConfirmText}"}),beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:"{i18n>ui5Submit}",press:function(){t._onFooterCancel(t);if(Object.entries(t.getService().getModel().mDeferredRequests).length>0){t.getService().getModel().mDeferredRequests={}}t._refreshData(t._projectId);s.close()}}),endButton:new sap.m.Button({text:"{i18n>ui5Cancel}",press:function(){s.close()}}),afterClose:function(){s.destroy()}});s.open()},onBatchSave:function(e){var t=this;var s=new sap.m.Dialog({title:"{i18n>ui5Confirm}",type:"Message",content:new sap.m.Text({text:"{i18n>ui5ConfirmText}"}),beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:"{i18n>ui5Submit}",press:function(){if(Object.entries(sap.ui.getCore().byId("ZPS_WEBAPP---project").getController().getModel("ChangeModel").getData()).length===0){s.close();return false}t.fireBatchSave();s.close()}}),endButton:new sap.m.Button({text:"{i18n>ui5Cancel}",press:function(){s.close()}}),afterClose:function(){s.destroy()}});s.open()},fireBatchSave:function(e){var t=this;this.getView().setBusy(true);var s=false;Object.keys(this.getModel("ChangeModel").getData()).forEach(function(e){var a=Object.keys(t.getModel("ChangeModel").getProperty("/"+e));if(e==="epta.ps.views.project.fragments.projectPlan.ProjectPlan"){a=Object.keys(t.getModel("ChangeModel").getProperty("/"+e)).sort()}a.forEach(function(a){var o=t.getModel("ChangeModel").getProperty("/"+e)[a];t.getService().getModel().update(o.service,o.data,{groupId:o.groupId});if(!s){s=Object.keys(t.getModel("ChangeModel").getProperty("/"+e)[a].data).indexOf("Apoc")>=0}})});var a={success:function(e){t.getView().setBusy(false);var a=400;try{if(e.__batchResponses[0].response&&e.__batchResponses[0].response.statusCode){a=parseInt(e.__batchResponses[0].response.statusCode)}else if(e.__batchResponses[0].__changeResponses&&e.__batchResponses[0].__changeResponses[0]){a=parseInt(e.__batchResponses[0].__changeResponses[0].statusCode||e.__batchResponses[0].__changeResponses[0].response.statusCode)}}catch(e){}if([200,202,204].indexOf(a)<0){t._onSuccessOrFailureDialog(e,"{i18n>ui5Failure}","Error","{i18n>ui5FailureText}");t._refreshData(t._projectId)}else{t._onSuccessOrFailureDialog(e,"{i18n>ui5Success}","Success","{i18n>ui5SuccessText}");t.getEventBus().publish("_onProjectDetail","refresh",t.getModel("NetworkActivity").getData())}t.getModel("ChangeModel").setData({});if(s){t._refreshDataHeader(t._projectId)}},error:function(e){t.getView().setBusy(false);t._onSuccessOrFailureDialog(e,"{i18n>ui5Failure}","Error","{i18n>ui5FailureText}")}};if(e){a.groupId=e}this.getService().saveData(a)},handleMessagePopoverPress:function(e){this._oMessagePopover.toggle(e.getSource())},onTableFilter:function(e){try{var t=this.getView().getContent()[0].getContent()[0].getFlexContent();var s=t.getItems().filter(function(e){return e.sId===t.getSelectedKey()})[0];s.getContent()[0].getContent()[0].getContent()[0].openFilterDialog()}catch(e){}},onShowProgressInfo:function(){var e=c.Information;switch(this.getModel("ProjectHeader").getProperty("/Ontime")){case"O":e=c.Success;break;case"W":e=c.Warning;break;case"D":e=c.Error;break;default:return}var t="";var s="";switch(this.getModel("ProjectHeader").getProperty("/Ontime")){case"O":t="{i18n>ui5Success}";s="{i18n>prgStatusOnTime}";break;case"W":t="{i18n>ui5Warning}";s="{i18n>prgStatusWarning}";break;case"D":t="{i18n>ui5Failure}";s="{i18n>prgStatusDelay}";break;default:return}if(!this.oMessageDialog){this.oMessageDialog=new u({type:d.Message,title:t,state:e,content:new h({text:s}),beginButton:new g({type:p.Emphasized,text:"OK",press:function(){this.oMessageDialog.close()}.bind(this)})})}this.oMessageDialog.open()},_onODataModel:function(e,t,s){this._oMsgModel.getData().push({type:s.type,title:s.title,description:s.message});this.getModel("layout").setProperty("/footer/messages",this.getModel("layout").getProperty("/footer/messages")+1);this._oMsgModel.refresh()},_addChange:function(e,t,s,a,o){var n=this.getModel("ChangeModel");if(!n.getProperty("/"+e)){n.setProperty("/"+e,{})}n.getProperty("/"+e)[t+s]={service:s,data:a,groupId:o}},_onSuccess:function(){sap.m.MessageToast.show("Saved",{duration:3e3,width:"10em",my:"center bottom",at:"center bottom",of:window,offset:"0 0",collision:"fit fit",onClose:null,autoClose:true,animationTimingFunction:"ease",animationDuration:1e3,closeOnBrowserNavigation:true})},_onFooterCancel:function(e){if(e.getService().getModel().hasPendingChanges()){var t=e.getService().getModel().getPendingChanges();for(var s in t){e.getService().getModel().resetChanges(t[s])}}e._refreshData(e._projectId)},_onObjectMatched:function(e){this._projectId=e.getParameter("arguments").projectId;this._refreshData(e.getParameter("arguments").projectId)},_refreshData:function(e){var t=this;this.getView().setBusy(true);this.getService().readProjectDataById({projectId:e,success:function(e){var s={Hierarchy:e.__batchResponses[0].data.results,NetworkActivity:e.__batchResponses[1].data.results,ProjectHeader:e.__batchResponses[2].data,WbselementData:e.__batchResponses[3].data.results,PurReq:e.__batchResponses[4].data?e.__batchResponses[4].data.results:[],InstallationManager:e.__batchResponses[5].data.results,Vendor:e.__batchResponses[6].data.results,WorkCenter:e.__batchResponses[7].data.results,SearchUom:e.__batchResponses[8].data.results,SearchCurc:e.__batchResponses[9].data.results,InstallationManagerFilter:e.__batchResponses[10].data.results};t.getModel("Hierarchy").setData(s.Hierarchy);t.getModel("NetworkActivity").setData(t._prepareNetworkActivity(s.NetworkActivity));t.getModel("ProjectHeader").setData(s.ProjectHeader);t.getModel("WbselementData").setData(t._prepareWBSelementData(s.WbselementData,s.Hierarchy));t.getModel("PurReq").setData(s.PurReq);t.getModel("InstallationManager").setData(s.InstallationManager);t.getModel("Vendor").setData(s.Vendor);t.getModel("WorkCenter").setData(s.WorkCenter);t.getModel("SearchUom").setData(s.SearchUom);t.getModel("SearchCurc").setData(s.SearchCurc);t.getModel("InstallationManagerFilter").setData(s.InstallationManagerFilter);t.getView().setBusy(false);t.getEventBus().publish("_onProjectDetail","read",s)},error:function(e){t.getView().setBusy(false)}})},_refreshDataHeader:function(e){var t=this;this.getService().readProjectHeaderDataById({projectId:e,success:function(e){t.getModel("ProjectHeader").setProperty("/Percentheader",e.__batchResponses[0].data.Percentheader)},error:function(e){t.getView().setBusy(false)}})},_prepareNetworkActivity:function(e){for(var t=0;t<e.length;t++){var s=e[t];if(s.UserStatus&&s.UserStatus.StatusId&&("CONF"===s.UserStatus.StatusId.substring(0,4)||"SCHE"===s.UserStatus.StatusId)){s.Freedefineddate1=null}}return e},_prepareWBSelementData:function(e,t){for(var s=0;s<e.length;s++){if(e[s].Wbselementhierarchylevel<3){e[s].isAPEnabled=false}if(e[s].Wbselementhierarchylevel>=3){e[s].isAPEnabled=e[s].Enabled&&["RSPS","RIAM"].indexOf(e[s].UserStatus.StatusId)<0}for(var a=0;a<t.length;a++){if(t[a].Wbselement===e[s].Wbselement){e[s].Wbselementparent=t[a].Up;break}}if("CONF"===e[s].UserStatus.StatusId.substring(0,4)||""===e[s].UserStatus.StatusId){e[s].isAPEnabled=true;e[s].Freedefineddate1=null}else{e[s].isAPEnabled=false}}return e}})});