sap.ui.define(["epta/ps/views/search/Search.controller","sap/ui/model/json/JSONModel","epta/ps/model/formatter","epta/ps/model/models","sap/ui/model/Filter","sap/ui/model/FilterOperator","epta/ps/ui5/controller/ErrorHandler","sap/ui/export/library","sap/ui/export/Spreadsheet"],function(e,t,a,r,o,i,s,n,l){"use strict";var g=n.EdmType;return e.extend("epta.ps.views.search.fragments.gantt.Gantt",{onInit:function(){this.getEventBus().subscribe("_onSearch","start",this._onSearch,this);this.getEventBus().subscribe("_onSearch","end",this._onSearch,this);debugger;this.getView().byId("gntGanttChartContainer").addCustomToolbarItem(new sap.m.Toolbar({content:[new sap.m.Button({icon:"sap-icon://download",press:this.exportExcel.bind(this)}),new sap.m.ToolbarSpacer({width:"10px"})]}));this.activitiesTree=[]},onRowSelectionChange:function(e){debugger;var t=e.getParameters().originEvent.getParameter("rowContext");if(!t){this.getView().getModel("footer").setProperty("/project","");this.getView().getModel("footer").setProperty("/enable",false);return}if(t.getModel().getProperty(t.getPath()+"/table/FunctionEnabled")!=="X"){this.getView().getModel("footer").setProperty("/project","");this.getView().getModel("footer").setProperty("/enable",false);return}var a=t.getModel().getProperty(t.getPath()+"/table/Wbselement");this.getView().getModel("footer").setProperty("/project",a);this.getView().getModel("footer").setProperty("/enable",true)},onNoteModify:function(e){this._oSelectedContext=e.getSource().getParent().getBindingContext();if(!this._oNoteDialog){this._oNoteDialog=sap.ui.xmlfragment("epta.ps.views.search.fragments.gantt.fragments.DialogNote",this);this.getView().addDependent(this._oNoteDialog)}this._oNoteDialog.getContent()[0].setValue(this._oSelectedContext.oModel.getProperty(this._oSelectedContext.sPath+"/table/Longtext"));this._oNoteDialog.open()},onNoteDialogSave:function(e){var t=this;var a=e.getSource().getContent()[0].getValue();this._oSelectedContext.oModel.setProperty(this._oSelectedContext.sPath+"/table/Longtext",a);this.getService().getModel().update("/WBSProjectSet('"+this._oSelectedContext.oModel.getProperty(this._oSelectedContext.sPath+"/table/Wbselement")+"')",{Longtext:a},{groupId:this.getService()._sGroupUpdateNoteId});this.getService().saveData({groupId:this.getService()._sGroupUpdateNoteId,success:function(e){t._onSuccessOrFailureDialog(e,"{i18n>ui5Success}","Success","{i18n>ui5Success}")},error:function(e){t._onSuccessOrFailureDialog(e,"{i18n>ui5Failure}","Error","{i18n>ui5Failure}")}})},_onSearch:function(e,t,a){if(t==="start"){this.getView().setBusy(true);return}var o=r.createGanttBaseModel();a.results.forEach(function(e){o.root.children.push(e)});var i=this._activitiesToTree(a.results);debugger;this.activitiesTree=a.results;this.getView().byId("gntGanttChartTable").setData(i);this.getView().setBusy(false);var s=this.getView().byId("gntGanttChartContainer").getGanttCharts()[0];s.jumpToPosition(new Date)},_activitiesToTree:function(e){var t=r.createGanttBaseModel();for(var o=0;o<e.length;o++){var i=e[o];var s=i.Basicstartdate;if(s){s=new Date(new Date(s).getTime()+new Date(s).getTimezoneOffset()*6e4)}var n=i.Basicenddate;if(n){n=new Date(new Date(n).getTime()+new Date(n).getTimezoneOffset()*6e4)}var l=i.Forecastedstartdate;if(l){l=new Date(new Date(l).getTime()+new Date(l).getTimezoneOffset()*6e4)}var g=i.Forecastedenddate;if(g){g=new Date(new Date(g).getTime()+new Date(g).getTimezoneOffset()*6e4)}var d=i.Wbsdescription;var c="";var u={id:("000"+o).substr(-3),wbs:i.Wbselement,level:"01",name:d,tooltip:d,table:i,children:[],order:[]};if(i.Basicstartdate&&i.Basicenddate){c=("0"+s.getDate()).substr(-2)+"/"+("0"+(s.getMonth()+1)).substr(-2);c+=" - "+("0"+n.getDate()).substr(-2)+"/"+("0"+(n.getMonth()+1)).substr(-2);u.order.push({startTime:s,endTime:n,level:"0",name:c})}if(i.Forecastedstartdate&&i.Forecastedenddate){c=("0"+l.getDate()).substr(-2)+"/"+("0"+(l.getMonth()+1)).substr(-2);c+=" - "+("0"+g.getDate()).substr(-2)+"/"+("0"+(g.getMonth()+1)).substr(-2);u.children.push({id:i.Wbselement,level:"02",name:d,tooltip:c,order:[{startTime:l,endTime:g,level:"1",name:c}],table:{Longtext:""}})}t.root.children.push(u);if(l&&l<t.ganttStartTime){t.ganttStartTime=l}if(s&&s<t.ganttStartTime){t.ganttStartTime=s}if(g&&g>t.ganttEndTime){t.ganttEndTime=g}if(n&&n>t.ganttEndTime){t.ganttEndTime=n}}t.ganttStartTime=a.dateToString(new Date(t.ganttStartTime.getFullYear(),t.ganttStartTime.getMonth()+1,1));t.ganttEndTime=a.dateToString(new Date(t.ganttEndTime.getFullYear(),t.ganttEndTime.getMonth()+3,0));return t},exportExcel:function(e){var t,a;t={workbook:{columns:this.createColumnConfig(),hierarchyLevel:"Level"},dataSource:this.activitiesTree,fileName:"ProjectManage.xlsx",worker:false};a=new l(t);a.build().finally(function(){a.destroy()})},createColumnConfig:function(){var e=this.getModel("i18n").getResourceBundle();var t=[];t.push({label:e.getText("tblWBE"),property:"Wbselement",type:g.String,width:"11em"});t.push({label:e.getText("tblWBEDescription"),property:"Wbsdescription",type:g.String,width:"20em"});t.push({label:e.getText("tblWbsForecastStartDate"),property:"Forecastedstartdate",type:g.Date});t.push({label:e.getText("tblWbsForecastFinishDate"),property:"Forecastedenddate",type:g.Date});t.push({label:e.getText("tblWbsBasicStartDate"),property:"Basicstartdate",type:g.Date});t.push({label:e.getText("tblWbsBasicFinishDate"),property:"Basicenddate",type:g.Date});return t}})});